<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <title>404 – Безопасная игра</title>

  <!-- Font: Press Start 2P -->
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <link id="themeStylesheet" rel="stylesheet" href="st1.css">

  <!-- Three.js, Cannon.js, Telegram Web App -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon/0.6.2/cannon.min.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Firebase SDK (compat версии) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-functions-compat.js"></script>
  
  <style>
    /* Пример дополнительных стилей для Bug Pack (Loot Box) */
    .case-container {
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-top: -60px;
      text-align: center;
      position: relative;
      top: 50px;
      display: inline-block;
      transition: top 0.5s ease;
    }
    .case-container.open {
      top: 20px;
    }
    .case-container img {
      display: block;
      margin: 0 auto;
      width: 330px;
      height: 330px;
      transition: width 0.5s ease, height 0.5s ease, transform 0.5s ease;
    }
    .case-container.open img {
      width: 500px;
      height: 500px;
      transform: translateY(-30px);
    }
    .explode {
      animation: explode 0.8s ease-out forwards;
    }
    @keyframes explode {
      0% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
        filter: brightness(1);
      }
      50% {
        transform: scale(1.3) rotate(20deg);
        opacity: 0.8;
        filter: brightness(1.2);
      }
      70% {
        transform: scale(1.1) rotate(10deg);
        opacity: 0.9;
        filter: brightness(1.1);
      }
      100% {
        transform: scale(2.5) rotate(45deg);
        opacity: 0;
        filter: brightness(0.5);
      }
    }
  </style>
</head>
<body>
  <!-- Header: Wallet, User Info, Balances -->
  <header>
    <a href="soon.html" id="walletLink" class="walletLink" style="position: absolute; top: 5px; left: 10px;">
      <img src="https://raw.githubusercontent.com/qnexst/404token/main/wallet.png" alt="Wallet" width="45" height="45"/>
    </a>
    <div class="user-info">
      <img id="userPhoto" src="" alt="Avatar"/>
      <span id="username">@User</span>
    </div>
    <div class="balances">
      <span>
        <img src="https://raw.githubusercontent.com/qnexst/404token/main/ticket.png" alt="Tickets" width="20"/>
        <span id="ticketCount">0</span>
      </span>
      <span>
        <img src="https://raw.githubusercontent.com/qnexst/404token/main/token.png" alt="Coins" width="20"/>
        <span id="coinCount">0</span>
      </span>
      <span>
        <img src="https://raw.githubusercontent.com/qnexst/404token/main/star.png" alt="Points" width="20"/>
        <span id="pointCount">0</span>
      </span>
    </div>
  </header>

  <!-- Main Content -->
  <main>
    <!-- PLAY SECTION -->
    <section id="playSection" class="section active">
      <div class="games-section">
        <h3>
          <span id="mainOnlineHeaderText">Online Games</span>
          <button id="mainOnlineInfoBtn" class="info-button" onclick="openMainOnlineInfoModal()">Info</button>
        </h3>
        <div class="games-gallery">
          <div class="game-card">
            <img src="https://raw.githubusercontent.com/qnexst/404token/main/1.jpg" alt="Special Game">
            <p id="gameCard1Title">Snake Online</p>
            <button id="gameCard1Button" onclick="window.location.href='specialgame.html'">Play</button>
          </div>
        </div>
      </div>

      <div class="games-section">
        <h3>
          <span id="miniGamesHeaderText">Mini-Games</span>
          <button id="miniGamesInfoBtn" class="info-button" onclick="openMiniGamesInfoModal()">Info</button>
        </h3>
        <div class="games-gallery">
          <!-- Игра STACK (game2) -->
          <div class="game-card">
            <img src="https://i.pinimg.com/736x/ed/0d/12/ed0d1214bfce57bc73d3207f47ac1d9e.jpg" alt="Match-3">
            <p id="gameCard2Title">PAC-MAN</p>
            <button id="gameCard2Button" onclick="openGameInfoModal({
              gameId: 'game2',
              title: 'PAC-MAN',
              img: 'https://i.pinimg.com/736x/ed/0d/12/ed0d1214bfce57bc73d3207f47ac1d9e.jpg',
              desc: 'Pac-Man is a classic arcade game in which each dot gives you one star.',
              cost: 1
            })">Play</button>
          </div>
          <!-- Игра TETRIS (game3) – критическая операция: списываются билеты через Cloud Function -->
          <div class="game-card">
            <img src="https://raw.githubusercontent.com/qnexst/404token/main/tetris.jpg" alt="Game 3">
            <p id="gameCard3Title">TETRIS</p>
            <button id="gameCard3Button" onclick="openGameInfoModal({
              gameId: 'game3',
              title: 'TETRIS',
              img: 'https://raw.githubusercontent.com/qnexst/404token/main/tetris.jpg',
              desc: 'Tetris is a classic tile-matching puzzle game. Each cleared row awards you 30 stars.',
              cost: 1
            })">Play</button>
          </div>
          <!-- Игра CROSSY ROAD (game4) -->
          <div class="game-card">
            <img src="https://i.pinimg.com/736x/ea/b7/75/eab775a90814f5df05466cc7ea4c590c.jpg" alt="Space Explorer">
            <p id="gameCard4Title">Crossy Road</p>
            <button id="gameCard4Button" onclick="openGameInfoModal({
              gameId: 'game4',
              title: 'Crossy Road',
              img: 'https://i.pinimg.com/736x/ea/b7/75/eab775a90814f5df05466cc7ea4c590c.jpg',
              desc: 'Crossy Road is a fast-paced arcade game where every step earns you 1 star.',
              cost: 1
            })">Play</button>
          </div>
          <!-- Игра Breakout -->
          <div class="game-card">
            <img src="https://raw.githubusercontent.com/qnexst/404token/main/breakout.jpg" alt="Breakout">
            <p id="gameCard7Title">Breakout</p>
            <button id="gameCard7Button" onclick="openGameInfoModal({
              gameId: 'breakout',
              title: 'Breakout',
              img: 'https://raw.githubusercontent.com/qnexst/404token/main/breakout.jpg',
              desc: 'Breakout is a classic arcade game where each broken brick awards you 5 stars.',
              cost: 1
            })">Play</button>
          </div>
        </div>
      </div>

      <div class="games-section">
        <h3>
          <span id="partnerGamesHeaderText">Partner Games</span>
          <button id="partnerInfoBtn" class="info-button" onclick="openPartnerInfoModal()">Info</button>
        </h3>
        <div class="games-gallery">
          <div class="game-card">
            <img src="https://img.icons8.com/ios-filled/50/00000/handshake.png" alt="Partner Game">
            <p id="gameCard5Title">Partner Game</p>
            <button id="gameCard5Button" style="display: none;" onclick="openGameInfoModal({ 
              gameId: 'partnergame1',
              title: 'soon',
              img: 'https://img.icons8.com/ios-filled/50/00000/handshake.png',
              desc: 'Game from our partner.',
              cost: 1
            })">Play</button>
          </div>
        </div>
      </div>
    </section>

    <!-- TICKETS SECTION -->
    <section id="ticketsSection" class="section">
      <h2 id="ticketsHeader">Tickets</h2>
      <div class="wheel-container">
        <div class="wheel" id="wheel">
          <div class="slice slice1">
            <img width="24" height="32" src="https://raw.githubusercontent.com/qnexst/404token/main/ticket.png" alt="ticket"/>
            <span>2</span>
          </div>
          <div class="slice slice2">
            <img width="24" height="32" src="https://raw.githubusercontent.com/qnexst/404token/main/ticket.png" alt="ticket"/>
            <span>5</span>
          </div>
          <div class="slice slice3">
            <img width="24" height="32" src="https://raw.githubusercontent.com/qnexst/404token/main/ticket.png" alt="ticket"/>
            <span>8</span>
          </div>
          <div class="slice slice4">
            <img width="24" height="32" src="https://raw.githubusercontent.com/qnexst/404token/main/ticket.png" alt="ticket"/>
            <span>10</span>
          </div>
          <div class="slice slice5">
            <img width="24" height="32" src="https://raw.githubusercontent.com/qnexst/404token/main/ticket.png" alt="ticket"/>
            <span>13</span>
          </div>
          <div class="slice slice6">
            <img width="24" height="32" src="https://raw.githubusercontent.com/qnexst/404token/main/ticket.png" alt="ticket"/>
            <span>15</span>
          </div>
        </div>
        <div class="wheel-pointer"></div>
        <div class="tickets-actions">
          <button id="spinButton" onclick="spinWheel()">Free Spin</button>
          <button id="buyTicketsBtn" onclick="buyTickets()">Buy Tickets</button>
        </div>
        <div class="spin-result" id="spinResult"></div>
      </div>
    </section>

    <!-- LEADERBOARD SECTION -->
    <section id="leaderboardSection" class="section">
      <h2 id="leaderboardHeader">Leaderboard</h2>
      <h2 id="leaderboardHeader">Season 1</h2>
      <button class="info-button" onclick="openSeasonInfoModal()">Info</button>
      <div class="leaderboard-container">
        <table id="leaderboardTable">
          <thead>
            <tr>
              <th>№</th>
              <th>Username</th>
              <th>Points</th>
              <th>Prize</th>
            </tr>
          </thead>
          <tbody id="leaderboardTop10">
            <!-- Top-10 players -->
          </tbody>
          <tbody id="leaderboardRest">
            <!-- Остальные игроки -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- LOOT BOX (Bug Packs) SECTION -->
    <section id="referralSection" class="section">
      <h2 id="referralHeader">Bug Packs</h2>
      <button class="info-button" onclick="openLootBoxInfoModal()">Info</button>
      <div class="case-container">
        <img id="caseImage" src="https://raw.githubusercontent.com/qnexst/404token/main/case.png" alt="Cyber Case">
      </div>
      <div class="lootbox-buttons">
        <button id="openBtn" onclick="openLootBox()">open (0)</button>
        <button id="openForTokenBtn" onclick="openLootBoxForTokens()">Open for 5m tokens</button>
      </div>
    </section>
  </main>

  <!-- Bottom Navigation -->
  <nav id="mainNav">
    <button onclick="showSection('playSection')">
      <img src="https://img.icons8.com/ios-filled/50/ffffff/playing.png" alt="Play" id="navPlayAlt"/>
    </button>
    <button onclick="showSection('ticketsSection')">
      <img src="https://img.icons8.com/ios-filled/50/ffffff/ticket.png" alt="Tickets" id="navTicketsAlt"/>
    </button>
    <button onclick="showSection('leaderboardSection')">
      <img src="https://img.icons8.com/ios-filled/50/ffffff/trophy.png" alt="Leaderboard" id="navLeaderboardAlt"/>
    </button>
    <button onclick="showSection('referralSection')">
      <img src="https://img.icons8.com/ios-filled/50/question-mark.png" alt="Cyber Case" id="navReferralAlt"/>
    </button>
  </nav>

  <!-- Глобальные модальные окна -->
  <div class="modal-backdrop" id="globalModalBackdrop">
    <div class="modal">
      <h2 id="globalModalTitle">Message</h2>
      <p id="globalModalMessage"></p>
      <button class="close-modal" onclick="closeGlobalModal()">OK</button>
    </div>
  </div>

  <div class="modal-backdrop" id="seasonModalBackdrop">
    <div class="modal modal-season">
      <h2 id="seasonModalTitle">Season Information</h2>
      <p id="seasonModalDesc">Season 1: The season lasts for 1 week, and at the end, the top 10 players receive BUG PACKs.</p>
      <button class="close-modal" onclick="closeSeasonModal()">Close</button>
    </div>
  </div>

  <div class="modal-backdrop" id="lootBoxInfoModal">
    <div class="modal">
      <h2 id="lootBoxInfoTitle">Bug Pack Info</h2>
      <p id="lootBoxInfoDesc">
        Prizes and Chances:<br>
        - 3 tickets (10%)<br>
        - 5 tickets (5%)<br>
        - 10 tickets (8%)<br>
        - 8 tickets (4%)<br>
        - One case (5%)<br>
        - 100 points (10%)<br>
        - 500 points (5%)<br>
        - 1M tokens (3%)<br>
        - 3M tokens (2%)<br>
        - 5M tokens (1%)<br>
        - NFT Red (1%) – Special<br>
        - NFT Yellow (2%) – Legendary<br>
        - NFT Green (3%) – Rare<br>
        - 1000 points (2%)
      </p>
      <button class="close-modal" onclick="closeLootBoxInfoModal()">Close</button>
    </div>
  </div>

  <div class="modal-backdrop" id="gameInfoModal">
    <div class="modal">
      <img id="gameInfoImg" src="" alt="Game Image" style="max-width:100px; display:block; margin:0 auto 10px;" />
      <h2 id="gameInfoTitle" style="text-align:center;"></h2>
      <p id="gameInfoDesc"></p>
      <button id="gameInfoPlayBtn">Play</button>
      <button class="close-modal" onclick="closeGameInfoModal()">Close</button>
    </div>
  </div>

  <div class="modal-backdrop" id="spinModalBackdrop">
    <div class="modal">
      <h2 id="spinModalTitle">You won <span id="wheelTicketCount"></span> tickets!</h2>
      <button class="close-modal" onclick="closeSpinModal()">OK</button>
    </div>
  </div>

  <div class="game-modal-backdrop" id="gameModalBackdrop">
    <div class="game-modal-content">
      <div class="game-canvas">
        <!-- Для TETRIS (game3) -->
        <canvas id="game3Canvas" width="400" height="740" style="display: none;"></canvas>
      </div>
    </div>
  </div>

  <div class="endgame-backdrop" id="endgameBackdrop">
    <div class="endgame-modal">
      <h2 id="endgameTitle">Result</h2>
      <p id="endgameMessage"></p>
      <button class="close-modal" onclick="finishGame()">Close</button>
    </div>
  </div>

  <div class="modal-backdrop" id="mainOnlineInfoModal">
    <div class="modal">
      <h2 id="mainOnlineInfoTitle">Online Games</h2>
      <p id="mainOnlineInfoDesc">Collection of arcade challenges where players can bet tokens or play for free.</p>
      <button class="close-modal" onclick="closeMainOnlineInfoModal()">Close</button>
    </div>
  </div>

  <div class="modal-backdrop" id="miniGamesInfoModal">
    <div class="modal">
      <h2 id="miniGamesInfoTitle">Mini Games Info</h2>
      <p id="miniGamesInfoDesc">Participate in mini games to earn tickets and points. Top players receive BUG PACKs weekly.</p>
      <button class="close-modal" onclick="closeMiniGamesInfoModal()">Close</button>
    </div>
  </div>

  <div class="modal-backdrop" id="partnerInfoModal">
    <div class="modal">
      <h2 id="partnerInfoTitle">Partner Games</h2>
      <p id="partnerInfoDesc">Game from our partner.</p>
      <button class="close-modal" onclick="closePartnerInfoModal()">Close</button>
    </div>
  </div>

  <div class="modal-backdrop" id="depositModal">
    <div class="modal">
      <h2 id="depositModalTitle">Not enough Tokens</h2>
      <p id="depositModalDesc">You do not have enough coins to play. Please top up your balance.</p>
      <button class="close-modal" onclick="closeDepositModal()">Close</button>
    </div>
  </div>

  <!-- Основной скрипт -->
  <script>
    // === Firebase Initialization ===
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
  
    const auth = firebase.auth();
    const db = firebase.database();
    const functions = firebase.functions();
  
    // === Telegram WebApp Integration ===
    const tg = window.Telegram.WebApp;
    tg.expand();
  
    // Глобальные переменные пользователя
    let currentUser = null;
    let localUserData = {
      photo: '',
      tickets: 0,
      coins: 0,
      points: 0,
      lootBoxes: 0, // Bug Packs
      nfts: []
    };
  
    // Функция форматирования монет
    function formatCoins(coins) {
      if (coins >= 1000000000) {
        return (coins / 1000000000).toFixed(1).replace(/\.0$/, '') + 'b';
      } else if (coins >= 1000000) {
        return (coins / 1000000).toFixed(1).replace(/\.0$/, '') + 'm';
      } else if (coins >= 1000) {
        return (coins / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
      }
      return coins;
    }
  
    // Обновление информации в верхней панели
    function updateTopBar() {
      document.getElementById('ticketCount').textContent = localUserData.tickets;
      document.getElementById('coinCount').textContent = formatCoins(localUserData.coins);
      document.getElementById('pointCount').textContent = localUserData.points;
      document.getElementById('openBtn').textContent = `open (${localUserData.lootBoxes})`;
    }
  
    // === Модальные окна ===
    function showGlobalModal(title, message) {
      document.getElementById('globalModalTitle').textContent = title;
      document.getElementById('globalModalMessage').textContent = message;
      document.getElementById('globalModalBackdrop').style.display = 'block';
    }
    function closeGlobalModal() {
      document.getElementById('globalModalBackdrop').style.display = 'none';
    }
    function openMainOnlineInfoModal() {
      document.getElementById('mainOnlineInfoModal').classList.add('active');
    }
    function closeMainOnlineInfoModal() {
      document.getElementById('mainOnlineInfoModal').classList.remove('active');
    }
    function openMiniGamesInfoModal() {
      document.getElementById('miniGamesInfoModal').classList.add('active');
    }
    function closeMiniGamesInfoModal() {
      document.getElementById('miniGamesInfoModal').classList.remove('active');
    }
    function openPartnerInfoModal() {
      document.getElementById('partnerInfoModal').classList.add('active');
    }
    function closePartnerInfoModal() {
      document.getElementById('partnerInfoModal').classList.remove('active');
    }
    function closeDepositModal() {
      document.getElementById('depositModal').classList.remove('active');
    }
    function openSeasonInfoModal() {
      document.getElementById('seasonModalBackdrop').classList.add('active');
    }
    function closeSeasonInfoModal() {
      document.getElementById('seasonModalBackdrop').classList.remove('active');
    }
    function closeLootBoxInfoModal() {
      document.getElementById('lootBoxInfoModal').classList.remove('active');
    }
  
    // === Аутентификация через Telegram через Cloud Function ===
    async function loginWithTelegram() {
      try {
        const loginFn = functions.httpsCallable('loginWithTelegram');
        // Передаём данные Telegram
        const result = await loginFn({ telegramData: tg.initDataUnsafe });
        const token = result.data.token;
        await auth.signInWithCustomToken(token);
        console.log("Успешная авторизация через Telegram");
      } catch (error) {
        console.error("Ошибка авторизации через Telegram:", error);
        showGlobalModal("Ошибка", "Не удалось авторизоваться через Telegram.");
      }
    }
  
    // Обработка изменения состояния аутентификации
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        console.log("Аутентифицированный пользователь:", user.uid);
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
          document.getElementById('username').textContent = '@' + tg.initDataUnsafe.user.username;
          if (tg.initDataUnsafe.user.photo_url) {
            document.getElementById('userPhoto').src = tg.initDataUnsafe.user.photo_url;
          }
        }
        const userRef = db.ref('users/' + user.uid);
        userRef.once('value', snapshot => {
          if (!snapshot.exists()) {
            userRef.set({
              photo: (tg.initDataUnsafe.user && tg.initDataUnsafe.user.photo_url) || '',
              tickets: 0,
              coins: 0,
              points: 0,
              lootBoxes: 1, // стартовое значение
              nfts: []
            });
          }
        });
        userRef.on('value', snapshot => {
          const data = snapshot.val() || {};
          localUserData = {
            photo: data.photo || '',
            tickets: data.tickets || 0,
            coins: data.coins || 0,
            points: data.points || 0,
            lootBoxes: data.lootBoxes || 0,
            nfts: data.nfts || []
          };
          updateTopBar();
        });
      } else {
        console.log("Пользователь не аутентифицирован");
      }
    });
  
    // === Модальное окно для Game Info ===
    function openGameInfoModal(gameData) {
      document.getElementById('gameInfoImg').src = gameData.img;
      document.getElementById('gameInfoTitle').textContent = gameData.title;
      document.getElementById('gameInfoDesc').textContent = gameData.desc;
      const playBtn = document.getElementById('gameInfoPlayBtn');
      playBtn.textContent = "Play (" + gameData.cost + " ticket)";
      playBtn.onclick = function() {
        closeGameInfoModal();
        handleStartGame(gameData.gameId, gameData.cost);
      };
      document.getElementById('gameInfoModal').classList.add('active');
    }
    function closeGameInfoModal() {
      document.getElementById('gameInfoModal').classList.remove('active');
    }
  
    // === Запуск игры (критическая операция для game3) ===
    let currentGame = null;
    let gameInProgress = false;
    function handleStartGame(gameName, ticketCost) {
      // Для других игр – просто редирект
      if (gameName === 'game2') {
        window.location.href = 'stack.html';
        return;
      }
      if (gameName === 'partnergame1') {
        window.location.href = 'partnergame.html';
        return;
      } else if (gameName === 'breakout') {
        window.location.href = 'breakout.html';
        return;
      } else if (gameName === 'game4') {
        window.location.href = 'space.html';
        return;
      }
  
      // Для game3 (TETRIS) списываем билеты через Cloud Function
      if (gameName === 'game3') {
        const startGameFn = functions.httpsCallable('startGame');
        startGameFn({ gameId: 'game3', ticketCost: ticketCost })
          .then(result => {
            localUserData.tickets = result.data.updatedData.tickets;
            updateTopBar();
            currentGame = gameName;
            gameInProgress = true;
            document.getElementById('mainNav').classList.add('hidden');
            document.getElementById('gameModalBackdrop').classList.add('active');
            document.getElementById('game3Canvas').style.display = 'block';
            initGame3();
          })
          .catch(error => {
            showGlobalModal("Not enough tickets", "You do not have enough tickets to play!");
          });
      }
    }
  
    // Завершение игры
    function finishGame() {
      document.querySelector('.user-info').style.display = '';
      document.getElementById('endgameBackdrop').classList.remove('active');
      closeGameModal();
    }
    function closeGameModal() {
      document.getElementById('gameModalBackdrop').classList.remove('active');
      document.getElementById('mainNav').classList.remove('hidden');
      if (currentGame === 'game3') {
        resetGame3();
      }
      currentGame = null;
      gameInProgress = false;
    }
  
    // === Free Spin: вызываем защищённую функцию spinWheel ===
    function spinWheel() {
      if (!currentUser) return;
      const spinWheelFn = functions.httpsCallable('spinWheel');
      spinWheelFn().then(result => {
        const wonTickets = result.data.wonTickets;
        localUserData.tickets = result.data.updatedData.tickets;
        updateTopBar();
        showSpinModal(wonTickets);
      }).catch(error => {
        showGlobalModal("Wheel of Fortune", error.message);
      });
    }
    function showSpinModal(amount) {
      document.getElementById("wheelTicketCount").textContent = amount;
      document.getElementById("spinModalTitle").innerHTML = "You won <span id='wheelTicketCount'>" + amount + "</span> tickets!";
      document.getElementById("spinModalBackdrop").classList.add("active");
    }
    function closeSpinModal() {
      document.getElementById("spinModalBackdrop").classList.remove("active");
    }
  
    // Функция для покупки билетов (редирект)
    function buyTickets() {
      window.location.href = 'buyticket.html';
    }
  
    // === Открытие лутбокса (Bug Pack) через Cloud Functions ===
    async function openLootBox() {
      if (!currentUser) {
        showGlobalModal("Ошибка", "Пользователь не аутентифицирован.");
        return;
      }
      try {
        const openLootBoxFn = functions.httpsCallable('openLootBox');
        const result = await openLootBoxFn();
        alert("Поздравляем, вы получили: " + result.data.prize);
      } catch (error) {
        console.error("Ошибка при открытии лутбокса:", error);
        showGlobalModal("Ошибка", "Не удалось открыть лутбокс.");
      }
    }
    async function openLootBoxForTokens() {
      if (!currentUser) {
        showGlobalModal("Ошибка", "Пользователь не аутентифицирован.");
        return;
      }
      try {
        const openLootBoxForTokensFn = functions.httpsCallable('openLootBoxForTokens');
        const result = await openLootBoxForTokensFn();
        alert("Поздравляем, вы получили: " + result.data.prize);
      } catch (error) {
        console.error("Ошибка при открытии лутбокса за токены:", error);
        showGlobalModal("Ошибка", "Не удалось открыть лутбокс за токены.");
      }
    }
  
    // === Инициализация игр (например, TETRIS) ===
    function initGame3() {
      // Здесь инициализация игры Tetris – оставьте существующую логику
      console.log("Инициализация TETRIS");
    }
    function resetGame3() {
      // Сброс состояния игры
      document.getElementById('game3Canvas').style.display = 'none';
      console.log("Сброс TETRIS");
    }
  
    // Переключение между разделами
    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.querySelectorAll('.modal-backdrop').forEach(modal => modal.classList.remove('active'));
      document.getElementById('gameModalBackdrop').classList.remove('active');
      document.getElementById('endgameBackdrop').classList.remove('active');
      document.getElementById(sectionId).classList.add('active');
    }
  
    // Запуск авторизации через Telegram при загрузке страницы
    window.addEventListener('load', () => {
      loginWithTelegram();
    });
  </script>
</body>
</html>
